{% extends "base.html" %}
{% block content %}
<h1>Applications</h1>
<div class="grid grid-2">
  <div class="card">
    <h3>Apply to Company</h3>
    <form method="post">
      {% if g.user.role != "STUDENT" %}
        <label>Student</label>
        <select name="student_id" required>
          <option value="">Select</option>
          {% for s in students %}
          <option value="{{ s.id }}">{{ s.roll_no }} - {{ s.name }}</option>
          {% endfor %}
        </select>
      {% else %}
        {% if students %}
          <p>Applying as: <b>{{ students[0].roll_no }} - {{ students[0].name }}</b></p>
        {% else %}
          <p>No linked student profile found for this account.</p>
        {% endif %}
      {% endif %}
      <label>Company</label>
      <select name="company_id" required>
        <option value="">Select</option>
        {% for c in companies %}
        <option value="{{ c.id }}">{{ c.name }}</option>
        {% endfor %}
      </select>
      <button type="submit">Submit Application</button>
    </form>
  </div>
  <div class="card">
    <h3>Eligibility Check</h3>
    <p>System blocks application when branch/CGPA/backlog criteria do not match company rules.</p>
  </div>
</div>

<h3>Submitted Applications</h3>
<table>
  <thead>
    <tr>
      <th>Applied At</th>
      <th>Student</th>
      <th>Company</th>
      <th>Company Policy</th>
      <th>Status</th>
      <th>Resume Link</th>
      <th>Exported At</th>
      {% if g.user.role in ["ADMIN", "PLACEMENT_COORDINATOR"] %}
      <th>Update Status</th>
      {% endif %}
    </tr>
  </thead>
  <tbody>
    {% for a in applications %}
    <tr>
      <td>{{ a.applied_at.strftime('%Y-%m-%d %H:%M') }}</td>
      <td>{{ a.student.roll_no }} - {{ a.student.name }}</td>
      <td>{{ a.company.name }}</td>
      <td>{{ a.company.selection_policy }}</td>
      <td>{{ a.status }}</td>
      <td>{{ a.student.resume_link or "Not set" }}</td>
      <td>{{ a.exported_at.strftime('%Y-%m-%d %H:%M') if a.exported_at else "-" }}</td>
      {% if g.user.role in ["ADMIN", "PLACEMENT_COORDINATOR"] %}
      <td>
        <form action="{{ url_for('update_application_status', application_id=a.id) }}" method="post">
          <select name="status" required>
            <option value="APPLIED">APPLIED</option>
            <option value="SHORTLISTED">SHORTLISTED</option>
            <option value="INTERVIEW">INTERVIEW</option>
            <option value="SELECTED">SELECTED</option>
            <option value="REJECTED">REJECTED</option>
          </select>
          <button type="submit">Save</button>
        </form>
      </td>
      {% endif %}
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
